<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Biof√≠sica UACH - Objeto 3: L√≠pidos y Membranas (Versi√≥n Completa)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
<style>
    /* =========================================
       ESTILOS GENERALES (BASE PLATAFORMA)
       ========================================= */
    :root {
        --color-primary: #7f1d1d;
        --color-primary-dark: #991b1b;
        --color-bg: #f3f4f6;
        /* Variables del Simulador */
        --color-sat: #15803d;
        --color-cis: #2563eb;
        --color-trans: #dc2626;
        --color-chol: #7c3aed;
    }

    * {margin:0;padding:0;box-sizing:border-box}
    body {font-family:system-ui,-apple-system,sans-serif;background:var(--color-bg);color:#111827;line-height:1.5}
    .container {max-width:1200px;margin:0 auto;padding:0 1rem}
    .hidden {display:none !important}

    /* Loading Overlay */
    .loading {position:fixed;inset:0;background:#f3f4f6;display:flex;align-items:center;justify-content:center;z-index:100;flex-direction:column;gap:1rem}
    .spinner {width:40px;height:40px;border:4px solid var(--color-primary);border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin {to{transform:rotate(360deg)}}

    /* Navbar */
    .navbar {position:fixed;top:0;left:0;right:0;background:white;border-bottom:1px solid #e5e7eb;z-index:50;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
    .navbar-content {display:flex;justify-content:space-between;align-items:center;height:4rem;padding:0 1rem}
    .brand {display:flex;align-items:center;gap:0.75rem}
    .brand-icon {width:2.5rem;height:2.5rem;background:var(--color-primary);color:white;border-radius:0.5rem;display:flex;align-items:center;justify-content:center;font-size:1.25rem}
    .brand-text h1 {font-size:0.875rem;font-weight:700;color:#111827}
    .brand-text p {font-size:0.75rem;color:#6b7280}

    /* Stats Header */
    .stats {display:flex;gap:1rem;align-items:center}
    .stat-item {text-align:center;padding:0.5rem;background:#f9fafb;border-radius:0.5rem;min-width:4rem}
    .stat-value {font-size:1.25rem;font-weight:700;color:var(--color-primary)}
    .stat-label {font-size:0.625rem;color:#6b7280;text-transform:uppercase}
    .progress {width:8rem}
    .progress-bar {height:0.5rem;background:#e5e7eb;border-radius:9999px;overflow:hidden;margin-top:0.25rem}
    .progress-fill {height:100%;background:var(--color-primary);transition:width 0.3s;width:0%}

    /* Main Content */
    main {padding-top:5rem;padding-bottom:3rem}
    .hero {background:linear-gradient(135deg,var(--color-primary),#991b1b);color:white;padding:2rem;border-radius:1rem;margin-bottom:2rem;position:relative;overflow:hidden}
    .hero::before {content:'';position:absolute;top:-50%;right:-10%;width:300px;height:300px;background:rgba(255,255,255,0.1);border-radius:50%;z-index:0}
    .hero-content {position:relative;z-index:1}
    .hero h2 {font-size:1.875rem;font-weight:700;margin-bottom:0.5rem}
    .btn {display:inline-flex;align-items:center;gap:0.5rem;padding:0.625rem 1.25rem;border-radius:0.5rem;font-weight:500;cursor:pointer;border:none;font-size:0.875rem;transition:all 0.2s}
    .btn-white {background:white;color:var(--color-primary)}
    .btn-white:hover {background:#f9fafb;transform:translateY(-1px)}
    .btn-outline {background:rgba(255,255,255,0.1);color:white;border:1px solid rgba(255,255,255,0.3)}
    .btn-outline:hover {background:rgba(255,255,255,0.2)}

    /* Tabs Navigation */
    .tabs {display:flex;gap:0.5rem;margin-bottom:2rem;background:white;padding:0.5rem;border-radius:0.75rem;box-shadow:0 1px 3px rgba(0,0,0,0.1);overflow-x:auto}
    .tab {padding:0.625rem 1rem;border-radius:0.5rem;cursor:pointer;white-space:nowrap;font-size:0.875rem;font-weight:500;color:#6b7280;transition:all 0.2s}
    .tab:hover {background:#f3f4f6}
    .tab.active {background:var(--color-primary);color:white}

    /* Cards */
    .card {background:white;border-radius:0.75rem;box-shadow:0 1px 3px rgba(0,0,0,0.1);border:1px solid #e5e7eb;margin-bottom:1.5rem;overflow:hidden}
    .card-header {padding:1rem 1.5rem;border-bottom:1px solid #e5e7eb;background:#f9fafb;font-weight:700;display:flex;align-items:center;gap:0.5rem}

    /* =========================================
       ESTILOS DEL SIMULADOR AVANZADO (INTEGRADO)
       ========================================= */
    .simulator-grid {display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; padding: 1.5rem;}
    @media (max-width: 900px) { .simulator-grid { grid-template-columns: 1fr; } }

    /* Botones de L√≠pido */
    .lipid-selector {display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 0.5rem; padding: 1rem;}
    .lipid-btn {
        padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 0.75rem; background: white; cursor: pointer; 
        transition: all 0.2s; text-align: center; font-size: 0.75rem; font-weight: 500; display: flex; flex-direction: column; align-items: center; gap: 0.25rem;
    }
    .lipid-btn:hover {border-color: var(--color-primary); transform: translateY(-2px);}
    .lipid-btn.active {border-color: var(--color-primary); background: #fef2f2; box-shadow: 0 0 0 2px rgba(127,29,29,0.1);}
    .lipid-btn i {font-size: 1.25rem; color: #555;}
    .lipid-btn.active i {color: var(--color-primary);}

    /* Visor Estructural SVG */
    .structure-viewer {min-height: 250px; background: #fafafa; border-radius: 0.75rem; padding: 1rem; border: 2px solid #e5e7eb; display: flex; justify-content: center; align-items: center;}
    .structure-svg {width: 100%; height: 200px; max-width: 350px;}

    /* Simulaci√≥n Membrana */
    .membrane-simulation {
        height: 350px; 
        background: linear-gradient(to bottom, #dbeafe 0%, #dbeafe 10%, white 10%, white 90%, #dbeafe 90%, #dbeafe 100%); 
        border-radius: 0.75rem; padding: 1rem; position: relative; overflow: hidden; border: 2px solid #e5e7eb;
    }
    .bilayer {position: relative; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 4px;}
    .layer {display: flex; justify-content: center; align-items: flex-end; gap: 2px; height: 100px; width: 100%;}
    .layer.upper {transform: scaleY(-1); border-bottom: 1px dashed rgba(0,0,0,0.1);}

    /* Mol√©culas del Simulador */
    .lipid-molecule {display: flex; flex-direction: column; align-items: center; width: 22px; position: relative; transform-origin: top center;}
    .head {
        width: 16px; height: 16px; border-radius: 50%; margin-bottom: -2px; z-index: 2;
        background: radial-gradient(circle at 30% 30%, #fbbf24, #d97706);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .tail-container {width: 100%; display: flex; justify-content: center; gap: 2px; transform-origin: top center;}
    .tail {width: 4px; height: 60px; border-radius: 3px; position: relative; opacity: 0.9;}

    /* Tipos de colas */
    .tail.straight {background: linear-gradient(to bottom, var(--color-sat), #14532d);}
    .tail.cis {
        background: linear-gradient(135deg, var(--color-cis), #1e3a8a);
        border-radius: 0 0 10px 10px; transform: rotate(-15deg) translateX(-5px); height: 50px;
    }
    .tail.trans {background: linear-gradient(to bottom, var(--color-trans), #7f1d1d);}
    .tail.cholesterol {height: 35px; width: 6px; background: var(--color-chol); border-radius: 4px; margin-top: 10px;}

    /* Animaciones Simulador */
    @keyframes sway { 0% { transform: rotate(-5deg); } 50% { transform: rotate(5deg); } 100% { transform: rotate(-5deg); } }
    @keyframes vibrate { 0% { transform: translateX(-1px); } 50% { transform: translateX(1px); } 100% { transform: translateX(-1px); } }
    .lipid-molecule.fluid-high .tail-container { animation: sway 2s infinite ease-in-out; }
    .lipid-molecule.fluid-low .tail-container { animation: vibrate 0.2s infinite linear; }
    .lipid-molecule.fluid-med .tail-container { animation: sway 4s infinite ease-in-out; }

    /* Medidor y Stats */
    .fluidity-meter {margin-top: 1rem; padding: 1rem; background: white; border-radius: 0.75rem; border: 1px solid #e5e7eb;}
    .meter-bar {height: 20px; background: #e5e7eb; border-radius: 1rem; overflow: hidden; position: relative; margin-top: 0.5rem;}
    .meter-fill {height: 100%; transition: width 0.5s; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.7rem; font-weight: 700;}
    .sim-stats-panel {display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; margin-top: 1rem;}
    .sim-stat-box {background: #f9fafb; padding: 0.5rem; border-radius: 0.5rem; text-align: center; border: 1px solid #e5e7eb;}
    .sim-stat-value {font-size: 1rem; font-weight: 700; color: #374151;}
    .sim-stat-label {font-size: 0.6rem; color: #6b7280;}

    /* Comparativa Grid */
    .comparison-grid {display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; padding: 1.5rem;}
    .comparison-card {padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 0.75rem; text-align: center; font-size: 0.8rem;}
    .comparison-card svg {margin: 0.5rem auto; display: block;}

    /* Paneles de Informaci√≥n */
    .info-panel {background: #eff6ff; border-left: 4px solid #3b82f6; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; font-size: 0.875rem;}
    .info-panel.warning {background: #fffbeb; border-left-color: #f59e0b;}
    .info-panel.danger {background: #fef2f2; border-left-color: #ef4444;}
    .info-panel.success {background: #f0fdf4; border-left-color: #22c55e;}

    /* =========================================
       ESTILOS DEL RESTO DE LA APP
       ========================================= */
    /* Quizzes */
    .quiz-container {padding:1.5rem}
    .quiz-question {margin-bottom:2rem}
    .quiz-q {font-weight:600;margin-bottom:1rem;font-size:1rem}
    .quiz-options {display:flex;flex-direction:column;gap:0.75rem}
    .quiz-option {padding:1rem;border:2px solid #e5e7eb;border-radius:0.5rem;cursor:pointer;transition:all 0.2s;background:white}
    .quiz-option:hover {border-color:var(--color-primary);background:#fef2f2}
    .quiz-option.selected {border-color:var(--color-primary);background:#fee2e2}
    .quiz-option.correct {border-color:#22c55e;background:#f0fdf4}
    .quiz-option.incorrect {border-color:#ef4444;background:#fef2f2}
    .quiz-feedback {margin-top:1rem;padding:1rem;border-radius:0.5rem;font-size:0.875rem}
    .quiz-feedback.correct {background:#f0fdf4;border:1px solid #86efac;color:#166534}
    .quiz-feedback.incorrect {background:#fef2f2;border:1px solid #fca5a5;color:#991b1b}

    /* Drag & Drop */
    .drag-drop-zone {padding:1.5rem}
    .drop-zones {display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1rem;margin-bottom:1.5rem}
    .drop-zone {min-height:200px;padding:1rem;border:2px dashed #d1d5db;border-radius:0.75rem;background:#fafafa}
    .drop-zone-title {font-weight:700;margin-bottom:0.75rem;color:#374151;text-align:center;padding-bottom:0.5rem;border-bottom:2px solid #e5e7eb}
    .drop-zone.over {border-color:var(--color-primary);background:#fef2f2}
    .draggables {display:flex;flex-wrap:wrap;gap:0.75rem;padding:1rem;background:#f9fafb;border-radius:0.5rem;margin-bottom:1rem}
    .draggable {padding:0.75rem 1rem;background:white;border:2px solid #d1d5db;border-radius:0.5rem;cursor:move;font-size:0.875rem;font-weight:500;transition:all 0.2s}
    .draggable:hover {border-color:var(--color-primary);transform:scale(1.05)}
    .draggable.dragging {opacity:0.5}
    .draggable.placed {background:#f0fdf4;border-color:#86efac}

    /* Calculadora */
    .calculator {padding:1.5rem}
    .calc-input {display:flex;flex-direction:column;gap:1rem;margin-bottom:1rem}
    .calc-input label {font-weight:600;font-size:0.875rem}
    .calc-input input,.calc-input select {padding:0.75rem;border:1px solid #d1d5db;border-radius:0.5rem;font-size:0.875rem}
    .calc-result {padding:1.5rem;background:#eff6ff;border:1px solid #bfdbfe;border-radius:0.75rem;margin-top:1rem}
    .calc-result-value {font-size:1.5rem;font-weight:700;color:#1e40af;margin-bottom:0.5rem}

    /* Logros */
    .achievement-bar {padding:1rem;background:white;border-radius:0.75rem;margin-bottom:1rem}
    .achievement-list {display:flex;gap:0.5rem;flex-wrap:wrap;margin-top:0.5rem}
    .achievement {padding:0.5rem 1rem;background:#f3f4f6;border-radius:0.5rem;font-size:0.75rem;display:flex;align-items:center;gap:0.5rem;opacity:0.6}
    .achievement.unlocked {background:#fef3c7;border:1px solid #fcd34d;opacity:1}

    /* Ejercicios */
    .question-list {padding:1.5rem}
    .question-item {margin-bottom:1.5rem;padding-left:1rem;border-left:4px solid #fbbf24;transition:all 0.3s}
    .question-item.completed {border-left-color:#22c55e;background:#f0fdf4;padding:1rem;border-radius:0 0.5rem 0.5rem 0}
    .question-text {font-weight:600;margin-bottom:0.5rem;display:block}
    textarea {width:100%;padding:0.75rem;border:1px solid #d1d5db;border-radius:0.5rem;font-family:inherit;font-size:0.875rem;resize:vertical;min-height:100px}
    textarea:focus {outline:none;border-color:var(--color-primary);box-shadow:0 0 0 3px rgba(127,29,29,0.1)}

    /* Flashcards */
    .flashcard-grid {display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1rem;margin:2rem 0}
    .flashcard {background:white;border:1px solid #e5e7eb;border-radius:0.75rem;padding:1.5rem;text-align:center;cursor:pointer;transition:transform 0.2s;box-shadow:0 1px 3px rgba(0,0,0,0.1);min-height:200px;display:flex;align-items:center;justify-content:center;flex-direction:column}
    .flashcard:hover {transform:translateY(-2px);box-shadow:0 4px 6px rgba(0,0,0,0.1)}
    .flashcard-front {font-weight:700;color:#111827;margin-bottom:0.5rem}
    .flashcard-back {display:none;color:#4b5563;font-size:0.875rem;padding-top:1rem;border-top:1px solid #e5e7eb;margin-top:1rem}
    .flashcard.flipped .flashcard-front {display:none}
    .flashcard.flipped .flashcard-back {display:block}

    /* Modales */
    .modal {display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:100;align-items:center;justify-content:center}
    .modal.show {display:flex}
    .modal-content {background:white;border-radius:1rem;padding:2rem;max-width:500px;margin:1rem;box-shadow:0 20px 25px -5px rgba(0,0,0,0.3)}
    .modal-header {font-size:1.25rem;font-weight:700;margin-bottom:1rem}
    .modal-footer {display:flex;gap:0.5rem;justify-content:flex-end}
    .btn-primary {background:var(--color-primary);color:white;border:none;padding:0.75rem 1.5rem;border-radius:0.5rem;font-weight:600;cursor:pointer}
    .btn-secondary {background:#f3f4f6;color:#374151;border:1px solid #d1d5db;padding:0.75rem 1.5rem;border-radius:0.5rem;font-weight:600;cursor:pointer}
    
    .alert {padding:1rem;border-radius:0.5rem;margin-bottom:1rem;border:1px solid}
    .alert-info {background:#eff6ff;border-color:#bfdbfe;color:#1e40af}
    .alert-warning {background:#fffbeb;border-color:#fcd34d;color:#92400e}

    /* =========================================
       NUEVOS ESTILOS DEL SISTEMA DE GUARDADO
       ========================================= */
    .save-system-fab {position:fixed;bottom:2rem;right:2rem;z-index:90;}
    .fab-button {
        width:3.5rem;height:3.5rem;border-radius:50%;background:var(--color-primary);color:white;
        border:none;box-shadow:0 4px 12px rgba(0,0,0,0.2);cursor:pointer;
        display:flex;align-items:center;justify-content:center;font-size:1.5rem;
        transition:transform 0.2s;
    }
    .fab-button:hover {transform:scale(1.1);background:var(--color-primary-dark);}
    .save-menu {
        position:absolute;bottom:4.5rem;right:0;width:280px;background:white;
        border-radius:0.75rem;box-shadow:0 10px 25px -5px rgba(0,0,0,0.2);
        padding:1rem;border:1px solid #e5e7eb;display:none;opacity:0;transform:translateY(10px);
        transition:all 0.2s;
    }
    .save-menu.show {display:block;opacity:1;transform:translateY(0);}
    .save-menu-header {font-weight:700;color:#374151;margin-bottom:0.75rem;padding-bottom:0.5rem;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;}
    .save-action-btn {
        width:100%;text-align:left;padding:0.75rem;background:white;border:1px solid #e5e7eb;
        border-radius:0.5rem;margin-bottom:0.5rem;cursor:pointer;display:flex;align-items:center;gap:0.75rem;
        font-size:0.875rem;transition:background 0.2s;color:#374151;
    }
    .save-action-btn:hover {background:#f9fafb;border-color:#d1d5db;}
    .save-action-btn i {width:20px;text-align:center;color:var(--color-primary);}
    .last-saved-time {text-align:center;font-size:0.75rem;color:#6b7280;margin-top:0.5rem;}
    
    .save-notification {
        position:fixed;bottom:2rem;left:50%;transform:translateX(-50%);
        background:rgba(31, 41, 55, 0.9);color:white;padding:0.75rem 1.5rem;
        border-radius:9999px;font-size:0.875rem;z-index:100;
        display:flex;align-items:center;gap:0.5rem;
        opacity:0;pointer-events:none;transition:opacity 0.3s;
    }
    .save-notification.show {opacity:1;}
    .hidden-file-input {display:none;}

    @media (max-width: 768px) {
        .stats {display:none}
        .simulator-grid {grid-template-columns:1fr}
        .comparison-grid {grid-template-columns:1fr}
        .save-system-fab {bottom: 1rem; right: 1rem;}
    }
</style>
</head>
<body>

<div id="loading" class="loading">
    <div class="spinner"></div>
    <p style="font-weight:600">Cargando Biof√≠sica Interactiva...</p>
</div>

<!-- SISTEMA DE NOTIFICACIONES -->
<div id="save-notification" class="save-notification">
    <i class="fas fa-check-circle"></i> <span id="save-message">Progreso guardado</span>
</div>

<div id="app" class="hidden">
    <nav class="navbar">
        <div class="navbar-content">
            <div class="brand">
                <div class="brand-icon">üß¨</div>
                <div class="brand-text">
                    <h1>Biof√≠sica UACH</h1>
                    <p>Objeto 3: L√≠pidos y Membranas</p>
                </div>
            </div>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="stat-points">0</div>
                    <div class="stat-label">Puntos</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stat-badges">0/10</div>
                    <div class="stat-label">Logros</div>
                </div>
                <div class="progress">
                    <div style="font-size:0.75rem;color:#6b7280">Progreso</div>
                    <div class="progress-bar"><div id="progress-fill" class="progress-fill"></div></div>
                </div>
            </div>
        </div>
    </nav>

    <!-- BOT√ìN FLOTANTE SISTEMA DE GUARDADO -->
    <div class="save-system-fab">
        <div class="save-menu" id="save-menu">
            <div class="save-menu-header">
                <span>Gesti√≥n de Progreso</span>
                <i class="fas fa-times" style="cursor:pointer" onclick="toggleSaveMenu()"></i>
            </div>
            <button class="save-action-btn" onclick="saveSystem.forceSave()">
                <i class="fas fa-save"></i> Guardar Ahora
            </button>
            <button class="save-action-btn" onclick="saveSystem.downloadBackup()">
                <i class="fas fa-download"></i> Descargar Respaldo
            </button>
            <button class="save-action-btn" onclick="document.getElementById('backup-upload').click()">
                <i class="fas fa-upload"></i> Restaurar Respaldo
            </button>
            <button class="save-action-btn" style="color:#ef4444;border-color:#fca5a5" onclick="saveSystem.clearProgress()">
                <i class="fas fa-trash-alt" style="color:#ef4444"></i> Borrar Todo
            </button>
            <div class="last-saved-time" id="menu-last-save">No guardado a√∫n</div>
            <input type="file" id="backup-upload" class="hidden-file-input" accept=".json" onchange="saveSystem.restoreBackup(this)">
        </div>
        <button class="fab-button" onclick="toggleSaveMenu()" title="Men√∫ de Guardado">
            <i class="fas fa-save"></i>
        </button>
    </div>

    <main class="container">
        <div class="hero">
            <div class="hero-content">
                <h2>üéØ L√≠pidos y Membranas - Modo Interactivo</h2>
                <p>Aprende mediante quizzes, simulaciones y actividades gamificadas</p>
                <div class="alert alert-info" style="background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.3);color:white;margin-top:1rem">
                    <i class="fas fa-shield-alt"></i> <strong>Sistema Seguro:</strong> Tu progreso se guarda autom√°ticamente. Descarga un respaldo üíæ si usas una computadora compartida.
                </div>
            </div>
        </div>

        <div class="achievement-bar">
            <div style="font-weight:700;margin-bottom:0.5rem">üèÜ Tus Logros</div>
            <div class="achievement-list">
                <div class="achievement" id="ach-1"><span>üéì</span> Primera pregunta</div>
                <div class="achievement" id="ach-2"><span>üìö</span> 10 completadas</div>
                <div class="achievement" id="ach-3"><span>‚ö°</span> Quiz perfecto</div>
                <div class="achievement" id="ach-4"><span>üéØ</span> Clasificaci√≥n</div>
                <div class="achievement" id="ach-5"><span>üß™</span> Cient√≠fico</div>
                <div class="achievement" id="ach-6"><span>üíØ</span> 50% progreso</div>
                <div class="achievement" id="ach-7"><span>üî¨</span> Todas desarrollo</div>
                <div class="achievement" id="ach-8"><span>üöÄ</span> Todas aplicaci√≥n</div>
                <div class="achievement" id="ach-9"><span>üëë</span> 100% completo</div>
                <div class="achievement" id="ach-10"><span>‚≠ê</span> Maestro l√≠pidos</div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="showTab('quizzes')">üìù Quizzes Interactivos</div>
            <div class="tab" onclick="showTab('simulator')">üß™ Simulador Interactivo</div>
            <div class="tab" onclick="showTab('drag-drop')">üéØ Clasificar L√≠pidos</div>
            <div class="tab" onclick="showTab('calculator')">üî¢ Calculadora</div>
            <div class="tab" onclick="showTab('flashcards')">üé¥ Flashcards</div>
            <div class="tab" onclick="showTab('ejercicios')">‚úçÔ∏è Ejercicios Escritos</div>
        </div>

        <!-- TAB: QUIZZES -->
        <div id="tab-quizzes" class="tab-content">
            <div class="card">
                <div class="card-header" style="background:#eff6ff;color:#1e40af">üìù Quizzes de Autoevaluaci√≥n</div>
                <div class="quiz-container" id="quiz-container"></div>
            </div>
        </div>

        <!-- TAB: SIMULATOR (AVANZADO INTEGRADO) -->
        <div id="tab-simulator" class="tab-content hidden">
            <div class="card">
                <div class="card-header" style="background:#f0fdf4;color:#166534">
                    <i class="fas fa-flask"></i> Laboratorio de Membranas
                </div>
                
                <!-- Selector de L√≠pidos -->
                <div class="lipid-selector">
                    <button class="lipid-btn active" onclick="lipidSim.selectLipid('saturado')" id="btn-saturado">
                        <i class="fas fa-ruler-horizontal" style="color: var(--color-sat)"></i>
                        <span>Saturado<br>(R√≠gido)</span>
                    </button>
                    <button class="lipid-btn" onclick="lipidSim.selectLipid('cis')" id="btn-cis">
                        <i class="fas fa-wave-square" style="color: var(--color-cis)"></i>
                        <span>Cis<br>(Fluido)</span>
                    </button>
                    <button class="lipid-btn" onclick="lipidSim.selectLipid('trans')" id="btn-trans">
                        <i class="fas fa-exclamation-triangle" style="color: var(--color-trans)"></i>
                        <span>Trans<br>(Nocivo)</span>
                    </button>
                    <button class="lipid-btn" onclick="lipidSim.selectLipid('colesterol')" id="btn-colesterol">
                        <i class="fas fa-gem" style="color: var(--color-chol)"></i>
                        <span>Colesterol<br>(Buffer)</span>
                    </button>
                    <button class="lipid-btn" onclick="lipidSim.selectLipid('mixto')" id="btn-mixto">
                        <i class="fas fa-layer-group" style="color: #4b5563"></i>
                        <span>Membrana<br>Real</span>
                    </button>
                </div>

                <div class="simulator-grid">
                    <!-- Visor de Estructura -->
                    <div>
                        <h4 style="margin-bottom:0.5rem;font-size:0.9rem;color:#555">üî¨ Estructura Molecular</h4>
                        <div class="structure-viewer">
                            <svg class="structure-svg" id="structure-svg" viewBox="0 0 300 250"></svg>
                        </div>
                        <div id="lipid-info"></div>
                    </div>

                    <!-- Simulaci√≥n de Membrana -->
                    <div>
                        <h4 style="margin-bottom:0.5rem;font-size:0.9rem;color:#555">üß™ Comportamiento en Membrana</h4>
                        <div class="membrane-simulation" id="membrane-sim">
                            <div class="bilayer" id="bilayer"></div>
                        </div>
                        
                        <div class="fluidity-meter">
                            <div style="display:flex; justify-content:space-between; margin-bottom:0.25rem; font-size:0.8rem">
                                <strong>Fluidez</strong>
                                <span id="fluidity-text-val">--</span>
                            </div>
                            <div class="meter-bar">
                                <div class="meter-fill" id="fluidity-fill" style="width:50%"></div>
                            </div>
                            <div class="sim-stats-panel">
                                <div class="sim-stat-box">
                                    <div class="sim-stat-value" id="stat-spacing">--</div>
                                    <div class="sim-stat-label">Espacio</div>
                                </div>
                                <div class="sim-stat-box">
                                    <div class="sim-stat-value" id="stat-packing">--</div>
                                    <div class="sim-stat-label">Empaque</div>
                                </div>
                                <div class="sim-stat-box">
                                    <div class="sim-stat-value" id="stat-temp">--</div>
                                    <div class="sim-stat-label">P. Fusi√≥n</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Comparativa -->
                <div class="comparison-grid">
                    <div class="comparison-card">
                        <h4 style="color:var(--color-sat)">Saturado</h4>
                        <svg width="40" height="40" viewBox="0 0 60 60"><line x1="10" y1="30" x2="50" y2="30" stroke="var(--color-sat)" stroke-width="4" stroke-linecap="round"/></svg>
                        <p>Ladrillo recto. S√≥lido y denso.</p>
                    </div>
                    <div class="comparison-card">
                        <h4 style="color:var(--color-cis)">Cis</h4>
                        <svg width="40" height="40" viewBox="0 0 60 60"><path d="M10 30 L25 30 L40 15 L55 15" fill="none" stroke="var(--color-cis)" stroke-width="4" stroke-linecap="round"/></svg>
                        <p>Curvo. L√≠quido y fluido.</p>
                    </div>
                    <div class="comparison-card">
                        <h4 style="color:var(--color-trans)">Trans</h4>
                        <svg width="40" height="40" viewBox="0 0 60 60"><line x1="10" y1="30" x2="50" y2="30" stroke="var(--color-trans)" stroke-width="4" stroke-linecap="round"/><text x="30" y="50" text-anchor="middle" font-size="10" fill="red">!</text></svg>
                        <p>Falso recto. Peligroso.</p>
                    </div>
                </div>
                
                <div class="info-panel warning" style="margin: 0 1.5rem 1.5rem 1.5rem">
                    <strong>üß† Impacto Neurol√≥gico:</strong> Las grasas trans endurecen la vaina de mielina, ralentizando los impulsos nerviosos y afectando la funci√≥n de receptores cr√≠ticos.
                </div>
            </div>
        </div>

        <!-- TAB: DRAG & DROP -->
        <div id="tab-drag-drop" class="tab-content hidden">
            <div class="card">
                <div class="card-header" style="background:#f0fdf4;color:#166534">üéØ Clasifica los L√≠pidos</div>
                <div class="drag-drop-zone">
                    <div class="alert alert-info"><strong>Instrucciones:</strong> Arrastra cada l√≠pido a su categor√≠a.</div>
                    <div class="draggables" id="draggables-lipids"></div>
                    <div class="drop-zones">
                        <div class="drop-zone" data-category="saturados">
                            <div class="drop-zone-title">Saturados</div><div class="drop-items"></div>
                        </div>
                        <div class="drop-zone" data-category="insaturados">
                            <div class="drop-zone-title">Insaturados</div><div class="drop-items"></div>
                        </div>
                        <div class="drop-zone" data-category="fosfolipidos">
                            <div class="drop-zone-title">Fosfol√≠pidos</div><div class="drop-items"></div>
                        </div>
                        <div class="drop-zone" data-category="esteroides">
                            <div class="drop-zone-title">Esteroides</div><div class="drop-items"></div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="checkDragDrop()" style="margin-top:1rem">Verificar Respuestas</button>
                    <button class="btn btn-secondary" onclick="resetDragDrop()" style="margin-top:1rem">Reiniciar</button>
                </div>
            </div>
        </div>

        <!-- TAB: CALCULATOR -->
        <div id="tab-calculator" class="tab-content hidden">
            <div class="card">
                <div class="card-header" style="background:#faf5ff;color:#7c3aed">üî¢ Calculadora de √çndice de Yodo</div>
                <div class="calculator">
                    <div class="alert alert-info"><strong>√çndice de Yodo:</strong> Mide el grado de insaturaci√≥n. Mayor √≠ndice = m√°s dobles enlaces.</div>
                    <div class="calc-input">
                        <label>Selecciona el √°cido graso:</label>
                        <select id="calc-fatty-acid" onchange="calculateIodine()">
                            <option value="">-- Selecciona --</option>
                            <option value="0">√Åcido Este√°rico (18:0) - Saturado</option>
                            <option value="90">√Åcido Oleico (18:1) - Monoinsaturado</option>
                            <option value="181">√Åcido Linol√©ico (18:2) - Poliinsaturado</option>
                            <option value="274">√Åcido Linol√©nico (18:3) - Poliinsaturado</option>
                            <option value="337">√Åcido Araquid√≥nico (20:4) - Poliinsaturado</option>
                        </select>
                    </div>
                    <div class="calc-result" id="calc-result" style="display:none">
                        <div class="calc-result-value" id="calc-value">--</div>
                        <div id="calc-interpretation"></div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header" style="background:#ecfdf5;color:#065f46">üìê Estimador de Punto de Fusi√≥n</div>
                <div class="calculator">
                    <div class="calc-input">
                        <label>Longitud de cadena (Carbonos):</label>
                        <input type="number" id="calc-chain-length" min="4" max="24" value="18" oninput="calculateMeltingPoint()">
                        <label>N√∫mero de dobles enlaces:</label>
                        <input type="number" id="calc-double-bonds" min="0" max="6" value="0" oninput="calculateMeltingPoint()">
                        <label>Configuraci√≥n:</label>
                        <select id="calc-config" onchange="calculateMeltingPoint()">
                            <option value="none">Sin dobles enlaces</option>
                            <option value="cis">Cis</option>
                            <option value="trans">Trans</option>
                        </select>
                    </div>
                    <div class="calc-result" id="calc-mp-result" style="display:none">
                        <div class="calc-result-value" id="calc-mp-value">--</div>
                        <div id="calc-mp-interpretation"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: FLASHCARDS -->
        <div id="tab-flashcards" class="tab-content hidden">
            <div class="card">
                <div class="card-header" style="background:#fef2f2;color:#991b1b">üé¥ Tarjetas de Estudio</div>
                <div style="padding:1.5rem">
                    <div class="flashcard-grid" id="flashcard-container"></div>
                </div>
            </div>
        </div>

        <!-- TAB: EJERCICIOS -->
        <div id="tab-ejercicios" class="tab-content hidden">
            <div id="preguntas-container"></div>
        </div>

        <footer>
            <p>Biof√≠sica UACH - Objeto de Estudio 3 - Versi√≥n Interactiva Completa</p>
            <p style="font-size:0.75rem;margin-top:0.25rem;color:#9ca3af" id="footer-last-save">-</p>
        </footer>
    </main>
</div>

<!-- Modal Logros -->
<div id="achievement-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">üéâ ¬°Logro Desbloqueado!</div>
        <div class="modal-body" style="text-align:center">
            <div style="font-size:4rem;margin:1rem 0" id="modal-badge"></div>
            <h3 id="modal-title" style="margin-bottom:0.5rem"></h3>
            <p id="modal-description" style="color:#6b7280"></p>
            <div style="margin-top:1rem;color:var(--color-primary);font-weight:700;font-size:1.5rem">+<span id="modal-points"></span> puntos</div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="closeAchievementModal()">¬°Genial!</button>
        </div>
    </div>
</div>

<script>
// ============================================
// SISTEMA DE GUARDADO ROBUSTO (INTEGRADO)
// ============================================
const saveSystem = {
    key: 'bio_uach_obj3',
    keyStats: 'bio_stats',
    autoSaveInterval: null,

    init: function() {
        // Cargar datos al inicio
        this.load();
        
        // Auto-guardado cada 10s
        this.autoSaveInterval = setInterval(() => {
            this.save(true);
        }, 10000);

        // Guardar antes de cerrar
        window.addEventListener('beforeunload', () => {
            this.save(false);
        });

        console.log('üõ°Ô∏è Sistema de Guardado Robusto Iniciado');
    },

    save: function(silent = false) {
        try {
            const data = JSON.stringify(respuestas);
            const stats = JSON.stringify(userStats);
            localStorage.setItem(this.key, data);
            localStorage.setItem(this.keyStats, stats);
            
            this.updateLastSaveTime();
            
            if (!silent) {
                this.showNotification('Progreso guardado correctamente');
            }
        } catch (e) {
            console.error('Error al guardar:', e);
            if (!silent) this.showNotification('‚ö†Ô∏è Error al guardar (Almacenamiento lleno?)');
        }
    },

    forceSave: function() {
        this.save(false);
        toggleSaveMenu(); // Cerrar men√∫
    },

    load: function() {
        try {
            const data = localStorage.getItem(this.key);
            const stats = localStorage.getItem(this.keyStats);
            
            if (data) respuestas = JSON.parse(data);
            if (stats) userStats = JSON.parse(stats);
            
            // Actualizar interfaz con datos cargados
            updateStats();
            this.updateLastSaveTime();
            
            // Si estamos en la pesta√±a de ejercicios, repintar
            if (currentTab === 'ejercicios') renderPreguntas();

        } catch (e) {
            console.error('Error al cargar:', e);
            this.showNotification('Error al cargar datos guardados');
        }
    },

    downloadBackup: function() {
        this.save(true); // Guardar estado actual primero
        const backup = {
            timestamp: new Date().toISOString(),
            respuestas: respuestas,
            stats: userStats,
            version: "1.0"
        };
        
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backup));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "biofisica_respaldo_" + new Date().toISOString().slice(0,10) + ".json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
        toggleSaveMenu();
    },

    restoreBackup: function(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const backup = JSON.parse(e.target.result);
                if (backup.respuestas && backup.stats) {
                    respuestas = backup.respuestas;
                    userStats = backup.stats;
                    
                    this.save(false); // Guardar en localStorage lo importado
                    updateStats();
                    renderPreguntas(); // Refrescar UI ejercicios
                    
                    this.showNotification('‚úÖ Respaldo restaurado con √©xito');
                    setTimeout(() => location.reload(), 1500); // Recargar para asegurar limpieza visual
                } else {
                    alert("El archivo no tiene el formato correcto.");
                }
            } catch (err) {
                console.error(err);
                alert("Error al leer el archivo de respaldo.");
            }
        };
        reader.readAsText(file);
        toggleSaveMenu();
    },

    clearProgress: function() {
        if(confirm("¬øEst√°s seguro de BORRAR todo tu progreso? Esta acci√≥n no se puede deshacer.")) {
            localStorage.removeItem(this.key);
            localStorage.removeItem(this.keyStats);
            location.reload();
        }
    },

    updateLastSaveTime: function() {
        const now = new Date().toLocaleTimeString();
        const msg = 'Guardado: ' + now;
        document.getElementById('menu-last-save').textContent = msg;
        const footer = document.getElementById('footer-last-save');
        if(footer) footer.textContent = msg;
    },

    showNotification: function(msg) {
        const notif = document.getElementById('save-notification');
        document.getElementById('save-message').textContent = msg;
        notif.classList.add('show');
        setTimeout(() => {
            notif.classList.remove('show');
        }, 3000);
    }
};

function toggleSaveMenu() {
    document.getElementById('save-menu').classList.toggle('show');
}

// ============================================
// VARIABLES GLOBALES Y DATOS (APP PRINCIPAL)
// ============================================
var respuestas = {};
var userStats = { points: 0, badges: 0, achievements: {}, quizzesCompleted: 0 };
var currentTab = 'quizzes';

// Datos Completos de Preguntas (NO PLACEHOLDERS)
var preguntasData = {
    pre:["¬øQu√© caracter√≠sticas comunes tienen aceite, mantequilla y colesterol?","Mencione 3 funciones de l√≠pidos.","Diferencia entre grasas s√≥lidas y l√≠quidas.","¬øQu√© sabe de saturadas vs insaturadas?","¬øQu√© l√≠pidos forman membranas y por qu√©?","¬øQu√© son vitaminas liposolubles?","¬øPor qu√© las grasas son energ√≠a concentrada?","¬øQu√© es el colesterol?","¬øC√≥mo se digieren las grasas en sangre acuosa?","¬øD√≥nde se encuentran omega-3 y omega-6?"],
    sec31:{titulo:"3.1 Introducci√≥n",dev:["Defina l√≠pidos por solubilidad.","Enumere funciones de l√≠pidos.","¬øPor qu√© son eficientes para energ√≠a vs gluc√≥geno?","Clasifique l√≠pidos en 6 categor√≠as."],app:["Funci√≥n de aislamiento t√©rmico.","L√≠pidos en secreciones de aves acu√°ticas.","Implicaciones dieta baja en grasas."]},
    sec32:{titulo:"3.2 √Åcidos Grasos",dev:["Estructura general (alfa, beta, omega).","Diferencia saturado vs insaturado.","Efecto del doble enlace cis.","Relaci√≥n saturaci√≥n-punto fusi√≥n.","Defina mono y poliinsaturado.","√Åcidos grasos esenciales.","Nomenclatura omega."],app:["Diferencia este√°rico vs oleico.","Hidrogenaci√≥n parcial y subproductos.","Ordene por punto fusi√≥n.","¬øAraquid√≥nico: omega-3 o 6?"]},
    sec33:{titulo:"3.3 TAGs y Ceras",dev:["Estructura TAG.","¬øPor qu√© son hidrof√≥bicos?","C√©lulas de almacenamiento.","Diferencia grasa vs aceite.","Saponificaci√≥n.","Composici√≥n de ceras.","Funci√≥n de ceras."],app:["Composici√≥n: aceite ma√≠z vs grasa res.","Jab√≥n como emulsionante.","Impermeabilidad de ceras."]},
    sec34:{titulo:"3.4 Fosfol√≠pidos",dev:["Naturaleza anfip√°tica.","¬øPor qu√© forman bicapa?","Dos clases principales.","Precursor fosfoglic√©rido.","4 alcoholes del fosfato.","Cardiolipina.","DPPC en surfactante pulmonar."],app:["Saturaci√≥n y fluidez.","Fosfolipasa C y PIP2.","Fosfatidilserina en apoptosis.","PLA2 en veneno de serpiente."]},
    sec35:{titulo:"3.5 Esfingol√≠pidos",dev:["Mol√©cula base.","Defina ceramida.","¬øD√≥nde hay esfingomielina?","Glicoesfingol√≠pidos.","Cerebr√≥sidos vs gangli√≥sidos.","Enzima deficiente en Tay-Sachs."],app:["Aislante el√©ctrico.","Toxina del c√≥lera y GM1.","Organulo en Gaucher.","Esqueletos: fosfatidilcolina vs esfingomielina."]},
    sec36:{titulo:"3.6 Isoprenoides",dev:["Unidad estructural.","Terpenos vs esteroides.","Clasificaci√≥n de terpenos.","Terpenoides mixtos.","N√∫cleo esteroideo.","S√≠ntesis desde colesterol.","Hormonas esteroideas."],app:["Beta-caroteno a vit A.","Colesterol y fluidez.","Colesterol vs √°cido c√≥lico.","Gluc√≥sidos card√≠acos."]},
    sec37:{titulo:"3.7 Eicosanoides",dev:["Precursor.","3 clases.","Liberaci√≥n de membrana (enzima).","Comparaci√≥n con hormonas.","Reacci√≥n COX.","Funciones fisiol√≥gicas."],app:["Aspirina e inhibici√≥n COX.","Inhibidores COX-2 selectivos.","Balance TXA2 vs PGI2.","Corticosteroides vs aspirina."]},
    sec38:{titulo:"3.8 Digesti√≥n",dev:["Desaf√≠os en medio acuoso.","Sales biliares.","Lipasa pancre√°tica.","Absorci√≥n en mucosa.","Quilomicrones.","Lipoprote√≠na lipasa."],app:["Obstrucci√≥n biliar y esteatorrea.","Olestra sin calor√≠as.","Fibra soluble y colesterol.","Hiperquilomicronemia familiar."]}
};

// Quizzes Completos (NO PLACEHOLDERS)
var quizzes = [
    {q: "¬øCu√°l es la principal diferencia entre un √°cido graso saturado y uno insaturado?", opts: ["El saturado tiene dobles enlaces, el insaturado no", "El saturado NO tiene dobles enlaces, el insaturado S√ç", "Ambos tienen dobles enlaces", "La diferencia est√° en el n√∫mero de carbonos"], correct: 1, explanation: "Los saturados est√°n 'llenos' de hidr√≥geno y son rectos. Los insaturados tienen dobles enlaces que crean curvaturas."},
    {q: "¬øQu√© efecto tiene un doble enlace CIS en la cadena de √°cidos grasos?", opts: ["Hace la cadena completamente recta", "Introduce una curvatura de ~30 grados", "No afecta la forma de la cadena", "Aumenta el punto de fusi√≥n"], correct: 1, explanation: "La curvatura impide que las mol√©culas se empaqueten densamente, aumentando la fluidez."},
    {q: "¬øPor qu√© los fosfol√≠pidos forman espont√°neamente bicapas en agua?", opts: ["Porque son hidrof√≠licos", "Porque son anfip√°ticos", "Porque son hidrof√≥bicos", "Por su tama√±o"], correct: 1, explanation: "Su naturaleza anfip√°tica (cabeza polar, cola apolar) los obliga a esconder las colas del agua."},
    {q: "¬øCu√°l es el precursor de los eicosanoides?", opts: ["√Åcido oleico", "√Åcido araquid√≥nico", "Colesterol", "Glucosa"], correct: 1, explanation: "El √°cido araquid√≥nico (20:4) se libera de la membrana para iniciar la se√±alizaci√≥n de inflamaci√≥n."},
    {q: "¬øQu√© enzima inhibe la aspirina?", opts: ["Lipasa", "Fosfolipasa A2", "Ciclooxigenasa (COX)", "Lipoprote√≠na lipasa"], correct: 2, explanation: "Inhibe la COX, bloqueando la producci√≥n de prostaglandinas y reduciendo dolor/inflamaci√≥n."},
    {q: "¬øQu√© estructura forma la esfingomielina en las neuronas?", opts: ["Membrana plasm√°tica", "Vaina de mielina", "N√∫cleo", "Citoplasma"], correct: 1, explanation: "Forma la vaina aislante que permite la conducci√≥n nerviosa r√°pida."},
    {q: "¬øQu√© lipoprote√≠na transporta l√≠pidos desde el intestino?", opts: ["LDL", "HDL", "Quilomicrones", "VLDL"], correct: 2, explanation: "Los quilomicrones transportan las grasas diet√©ticas desde el intestino a los tejidos."},
    {q: "El √°cido araquid√≥nico 20:4(œâ-6) es:", opts: ["Omega-3", "Omega-6", "Omega-9", "Saturado"], correct: 1, explanation: "Es un √°cido graso poliinsaturado de la serie Omega-6."}
];

// L√≠pidos Drag & Drop (NO PLACEHOLDERS)
var lipidsData = [
    {name: "√Åcido Este√°rico (18:0)", category: "saturados"},
    {name: "√Åcido Palm√≠tico (16:0)", category: "saturados"},
    {name: "√Åcido Oleico (18:1 cis)", category: "insaturados"},
    {name: "√Åcido Linol√©ico (18:2)", category: "insaturados"},
    {name: "Fosfatidilcolina", category: "fosfolipidos"},
    {name: "Fosfatidilserina", category: "fosfolipidos"},
    {name: "Esfingomielina", category: "fosfolipidos"},
    {name: "Colesterol", category: "esteroides"},
    {name: "Testosterona", category: "esteroides"},
    {name: "Cortisol", category: "esteroides"}
];

// Flashcards (NO PLACEHOLDERS)
var flashcardsData = [
    {front: "¬øQu√© son los l√≠pidos?", back: "Biomol√©culas insolubles en agua, solubles en solventes org√°nicos."},
    {front: "Diferencia cis vs trans", back: "CIS: Curvo (natural). TRANS: Recto (industrial/nocivo)."},
    {front: "¬øQu√© es un fosfol√≠pido?", back: "L√≠pido anfip√°tico principal de membranas (Glicerol + 2 AG + P + Alcohol)."},
    {front: "Funci√≥n del colesterol", back: "Regula fluidez de membrana y es precursor de hormonas esteroideas."},
    {front: "¬øQu√© son eicosanoides?", back: "Se√±alizadores locales (inflamaci√≥n) derivados del √°c. araquid√≥nico."},
    {front: "Saponificaci√≥n", back: "Reacci√≥n de grasas con base fuerte para formar jab√≥n (sales de AG)."},
    {front: "Omega-3 vs Omega-6", back: "Omega-3 (antiinflamatorio) vs Omega-6 (proinflamatorio en exceso)."},
    {front: "Vaina de mielina", back: "Aislante el√©ctrico rico en esfingol√≠pidos que recubre axones."},
    {front: "Sales biliares", back: "Detergentes biol√≥gicos que emulsionan grasas para su digesti√≥n."},
    {front: "LDL vs HDL", back: "LDL lleva colesterol a tejidos. HDL lo retira al h√≠gado (limpieza)."}
];

// Logros
var achievements = {
    1: {icon: "üéì", title: "Primer Paso", desc: "Completaste tu primera pregunta", points: 10},
    2: {icon: "üìö", title: "Estudiante Dedicado", desc: "10 preguntas completadas", points: 50},
    3: {icon: "‚ö°", title: "Quiz Perfecto", desc: "Quiz sin errores", points: 100},
    4: {icon: "üéØ", title: "Clasificador Experto", desc: "Completaste clasificaci√≥n l√≠pidos", points: 75},
    5: {icon: "üß™", title: "Cient√≠fico", desc: "Usaste el simulador avanzado", points: 50},
    6: {icon: "üíØ", title: "Medio Camino", desc: "50% de progreso", points: 150},
    7: {icon: "üî¨", title: "Desarrollo Master", desc: "Todas las de desarrollo", points: 200},
    8: {icon: "üöÄ", title: "Aplicaci√≥n Pro", desc: "Todas las de aplicaci√≥n", points: 200},
    9: {icon: "üëë", title: "Completado 100%", desc: "Todas las actividades", points: 500},
    10: {icon: "‚≠ê", title: "Maestro de L√≠pidos", desc: "Dominaste el tema", points: 1000}
};

// ============================================
// L√ìGICA DEL SIMULADOR AVANZADO (INTEGRADO)
// ============================================
const lipidSim = {
    currentType: 'saturado',
    data: {
        saturado: {
            name: '√Åcido Graso SATURADO',
            structure: 'Cadena lineal (sin dobles enlaces)',
            desc: 'Al ser rectas, las cadenas se empaquetan muy juntas (como ladrillos). Esto crea una membrana densa y r√≠gida, con poca movilidad.',
            props: ['Cadena recta', 'Alta densidad', 'S√≥lido a T¬∞ ambiente'],
            fluidity: 15, spacing: 'Muy Denso', packing: 'M√°ximo', temp: '69.6¬∞C',
            color: '#15803d', warning: false, animClass: 'fluid-low'
        },
        cis: {
            name: '√Åcido Graso CIS (Saludable)',
            structure: 'Doble enlace Cis (curvatura)',
            desc: 'La curvatura natural ("kink") impide que las mol√©culas se junten demasiado. Crea "bolsillos" de espacio que mantienen la membrana fluida.',
            props: ['Curvatura de 30¬∞', 'Espacios libres', 'L√≠quido a T¬∞ ambiente'],
            fluidity: 90, spacing: 'Amplio', packing: 'Bajo', temp: '13.4¬∞C',
            color: '#2563eb', warning: false, animClass: 'fluid-high'
        },
        trans: {
            name: '√Åcido Graso TRANS (Industrial)',
            structure: 'Doble enlace Trans (pseudo-recto)',
            desc: 'Aunque es insaturado, su geometr√≠a es RECTA. La c√©lula lo confunde con un saturado, endureciendo peligrosamente la membrana.',
            props: ['Geometr√≠a lineal', 'Comportamiento saturado', 'Dif√≠cil de metabolizar'],
            fluidity: 25, spacing: 'Denso', packing: 'Alto', temp: '44¬∞C',
            color: '#dc2626', warning: true, animClass: 'fluid-low'
        },
        colesterol: {
            name: 'Colesterol',
            structure: 'Anillo esteroideo',
            desc: 'Act√∫a como un "buffer" o amortiguador de fluidez. Evita que la membrana se congele a bajas T¬∞ y que se deshaga a altas T¬∞.',
            props: ['Anillo r√≠gido', 'Cola flexible', 'Regulador de fluidez'],
            fluidity: 50, spacing: 'Medio', packing: 'Regulado', temp: '148¬∞C',
            color: '#7c3aed', warning: false, animClass: 'fluid-med'
        },
        mixto: {
            name: 'Membrana Realista (Mixta)',
            structure: 'Mosaico de componentes',
            desc: 'Una c√©lula sana combina saturados para estabilidad, insaturados para fluidez y colesterol para regulaci√≥n. El equilibrio es clave.',
            props: ['Equilibrio din√°mico', 'Balsas lip√≠dicas', 'Funcionalidad √≥ptima'],
            fluidity: 65, spacing: '√ìptimo', packing: 'Medio', temp: 'Din√°mico',
            color: '#4b5563', warning: false, animClass: 'fluid-med'
        }
    },

    init: function() {
        this.selectLipid('saturado');
    },

    selectLipid: function(type) {
        this.currentType = type;
        document.querySelectorAll('.lipid-btn').forEach(b => b.classList.remove('active'));
        const btn = document.getElementById('btn-' + type);
        if(btn) btn.classList.add('active');
        
        this.updateStructure(type);
        this.simulateMembrane(type);
        this.updateInfo(type);
        unlockAchievement(5); // Logro Cient√≠fico
    },

    updateInfo: function(type) {
        const d = this.data[type];
        const panel = document.getElementById('lipid-info');
        panel.innerHTML = `
            <div class="info-panel ${d.warning ? 'danger' : 'success'}" style="margin-top:0.5rem">
                <strong>${d.name}</strong><br>
                <small>${d.structure}</small>
                <p style="margin-top:0.5rem;font-size:0.85rem">${d.desc}</p>
            </div>
        `;
    },

    simulateMembrane: function(type) {
        const bilayer = document.getElementById('bilayer');
        if(!bilayer) return;
        bilayer.innerHTML = '';
        
        const d = this.data[type];
        const upper = document.createElement('div'); upper.className = 'layer upper';
        const lower = document.createElement('div'); lower.className = 'layer';
        
        let count = 12; // Cantidad de l√≠pidos para visualizaci√≥n clara
        let composition = [];
        
        if (type === 'mixto') {
            for(let i=0; i<count; i++) {
                let r = Math.random();
                if (r < 0.4) composition.push('saturado');
                else if (r < 0.8) composition.push('cis');
                else composition.push('colesterol');
            }
        } else {
            composition = Array(count).fill(type);
        }

        composition.forEach(t => {
            upper.appendChild(this.createMolecule(t));
            lower.appendChild(this.createMolecule(t));
        });

        bilayer.appendChild(upper); bilayer.appendChild(lower);
        this.updateMeter(d);
    },

    createMolecule: function(type) {
        const mol = document.createElement('div');
        mol.className = `lipid-molecule ${this.data[type].animClass}`;
        
        const head = document.createElement('div');
        head.className = 'head';
        if(type === 'colesterol') head.style.background = '#ddd6fe';

        const tailContainer = document.createElement('div');
        tailContainer.className = 'tail-container';

        if (type === 'colesterol') {
            const tail = document.createElement('div'); tail.className = 'tail cholesterol';
            tailContainer.appendChild(tail);
        } else {
            const t1 = document.createElement('div');
            const t2 = document.createElement('div');
            t1.className = `tail ${type === 'saturado'||type==='trans' ? 'straight' : 'cis'}`;
            t2.className = `tail ${type === 'trans' ? 'trans' : (type === 'saturado' ? 'straight' : 'cis')}`;
            if(type === 'cis') t2.style.transform = 'rotate(-20deg) translateX(-3px)';
            tailContainer.appendChild(t1); tailContainer.appendChild(t2);
        }
        mol.appendChild(head); mol.appendChild(tailContainer);
        return mol;
    },

    updateMeter: function(d) {
        const fill = document.getElementById('fluidity-fill');
        if(fill) {
            fill.style.width = d.fluidity + '%';
            fill.style.background = d.fluidity < 40 ? '#ef4444' : (d.fluidity > 80 ? '#3b82f6' : '#22c55e');
            fill.textContent = d.fluidity + '%';
        }
        document.getElementById('fluidity-text-val').textContent = d.fluidity < 40 ? 'Baja (R√≠gida)' : 'Alta (Fluida)';
        document.getElementById('stat-spacing').innerText = d.spacing;
        document.getElementById('stat-packing').innerText = d.packing;
        document.getElementById('stat-temp').innerText = d.temp;
    },

    updateStructure: function(type) {
        const svg = document.getElementById('structure-svg');
        if(!svg) return;
        svg.innerHTML = '';
        const ns = "http://www.w3.org/2000/svg";
        const color = this.data[type].color;
        
        const drawHead = (x=150, y=100) => {
            const h = document.createElementNS(ns, 'circle');
            h.setAttribute('cx', x); h.setAttribute('cy', y); h.setAttribute('r', '12'); h.setAttribute('fill', '#fbbf24');
            svg.appendChild(h);
        }
        const drawLine = (pts) => {
            const p = document.createElementNS(ns, 'polyline');
            p.setAttribute('points', pts); p.setAttribute('fill', 'none'); p.setAttribute('stroke', color); p.setAttribute('stroke-width', '6'); p.setAttribute('stroke-linecap', 'round'); p.setAttribute('stroke-linejoin', 'round');
            svg.appendChild(p);
        }

        if(type==='saturado' || type==='trans') {
            drawHead();
            let pts = "150,100 "; for(let i=1;i<8;i++) pts+=`${150+i*20},${100+(i%2==0?10:-10)} `;
            drawLine(pts);
            if(type==='trans') {
                const w = document.createElementNS(ns,'text'); 
                w.setAttribute('x',200); w.setAttribute('y',50); w.textContent='‚ö†Ô∏è'; svg.appendChild(w);
            }
        } else if(type==='cis') {
            drawHead();
            let pts1 = "150,100 170,90 190,100 210,90"; 
            let pts2 = "210,90 230,120 250,110 270,120"; // Quiebre
            drawLine(pts1); drawLine(pts2);
        } else if(type==='colesterol') {
            drawHead();
            const r = document.createElementNS(ns,'rect');
            r.setAttribute('x',160); r.setAttribute('y',90); r.setAttribute('width',60); r.setAttribute('height',20);
            r.setAttribute('stroke',color); r.setAttribute('fill','none'); r.setAttribute('stroke-width','3');
            svg.appendChild(r);
        } else { 
            const t = document.createElementNS(ns,'text');
            t.setAttribute('x',150); t.setAttribute('y',125); t.setAttribute('text-anchor','middle');
            t.textContent = 'Mezcla Compleja'; svg.appendChild(t);
        }
    }
};

// ============================================
// FUNCIONES GENERALES APP (MODIFICADAS PARA USAR saveSystem)
// ============================================

function init() {
    // Inicializar el sistema de guardado primero
    saveSystem.init();
    
    renderQuizzes();
    renderDragDrop();
    renderFlashcards();
    renderPreguntas();
    
    // Iniciar Simulador
    lipidSim.init();
    
    showTab('quizzes');
    setTimeout(() => {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
    }, 500);
}

function showTab(tab) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
    
    const activeTab = document.querySelector(`.tab[onclick="showTab('${tab}')"]`);
    if(activeTab) activeTab.classList.add('active');
    
    const content = document.getElementById('tab-'+tab);
    if(content) content.classList.remove('hidden');
    
    // Asignar tab actual para l√≥gica de repintado
    currentTab = tab;

    // Forzar repintado del simulador si se abre
    if(tab === 'simulator') {
        lipidSim.simulateMembrane(lipidSim.currentType);
    }
}

// L√ìGICA LOGROS Y PUNTOS (INTEGRADA)
function addPoints(pts) { 
    userStats.points += pts; 
    updateStats(); 
    saveSystem.save(true); 
}

function unlockAchievement(id) {
    if(userStats.achievements[id]) return;
    userStats.achievements[id] = true;
    userStats.badges++;
    var ach = achievements[id];
    addPoints(ach.points);
    showAchievementModal(id);
    updateStats();
}

function checkAchievement(id) {
    if(!userStats.achievements[id]) unlockAchievement(id);
}

function showAchievementModal(id) {
    var ach = achievements[id];
    document.getElementById('modal-badge').textContent = ach.icon;
    document.getElementById('modal-title').textContent = ach.title;
    document.getElementById('modal-description').textContent = ach.desc;
    document.getElementById('modal-points').textContent = ach.points;
    document.getElementById('achievement-modal').classList.add('show');
}

function closeAchievementModal() { 
    document.getElementById('achievement-modal').classList.remove('show'); 
}

function updateStats() {
    document.getElementById('stat-points').textContent = userStats.points;
    document.getElementById('stat-badges').textContent = userStats.badges + '/10';
    var pct = Math.min(100, Math.floor((userStats.points / 1500) * 100));
    document.getElementById('progress-fill').style.width = pct + '%';
    if(pct >= 50 && !userStats.achievements[6]) unlockAchievement(6);
    if(pct >= 100 && !userStats.achievements[9]) unlockAchievement(9);
}

// L√ìGICA QUIZZES
function renderQuizzes() {
    let html = '<div class="alert alert-info"><strong>üìù Instrucciones:</strong> Responde cada pregunta y gana puntos.</div>';
    quizzes.forEach((q, i) => {
        html += `<div class="quiz-question" id="quiz-${i}">`;
        html += `<div class="quiz-q">${i+1}. ${q.q}</div>`;
        html += `<div class="quiz-options">`;
        q.opts.forEach((opt, j) => {
            html += `<div class="quiz-option" onclick="selectQuizOption(${i},${j})">${opt}</div>`;
        });
        html += `</div><div id="quiz-feedback-${i}"></div></div>`;
    });
    document.getElementById('quiz-container').innerHTML = html;
}

function selectQuizOption(qIdx, oIdx) {
    const q = quizzes[qIdx];
    const opts = document.querySelectorAll(`#quiz-${qIdx} .quiz-option`);
    opts.forEach(o => { o.classList.remove('selected','correct','incorrect'); o.style.pointerEvents='none'; });
    opts[oIdx].classList.add('selected');
    
    const feed = document.getElementById(`quiz-feedback-${qIdx}`);
    if(oIdx === q.correct) {
        opts[oIdx].classList.add('correct');
        feed.className = 'quiz-feedback correct';
        feed.innerHTML = `<strong>¬°Correcto!</strong> ${q.explanation}`;
        addPoints(10);
        userStats.quizzesCompleted++;
        checkAchievement(3);
    } else {
        opts[oIdx].classList.add('incorrect');
        opts[q.correct].classList.add('correct');
        feed.className = 'quiz-feedback incorrect';
        feed.innerHTML = `<strong>Incorrecto.</strong> La respuesta era: ${q.opts[q.correct]}.<br>${q.explanation}`;
    }
    saveSystem.save(true);
}

// L√ìGICA DRAG & DROP
function renderDragDrop() {
    let html = '';
    lipidsData.forEach((l, i) => {
        html += `<div class="draggable" draggable="true" data-cat="${l.category}" id="drag-${i}">${l.name}</div>`;
    });
    document.getElementById('draggables-lipids').innerHTML = html;
    
    document.querySelectorAll('.draggable').forEach(d => {
        d.addEventListener('dragstart', e => { e.dataTransfer.setData('text', e.target.id); e.target.classList.add('dragging'); });
        d.addEventListener('dragend', e => e.target.classList.remove('dragging'));
    });
    
    document.querySelectorAll('.drop-zone').forEach(z => {
        z.addEventListener('dragover', e => { e.preventDefault(); z.classList.add('over'); });
        z.addEventListener('dragleave', e => z.classList.remove('over'));
        z.addEventListener('drop', e => {
            e.preventDefault(); z.classList.remove('over');
            const id = e.dataTransfer.getData('text');
            const el = document.getElementById(id);
            if(el) z.querySelector('.drop-items').appendChild(el);
        });
    });
}

function checkDragDrop() {
    let correct = 0;
    const draggables = document.querySelectorAll('.draggable');
    draggables.forEach(d => {
        const parent = d.parentElement.parentElement;
        if(parent.dataset.category === d.dataset.cat) {
            d.classList.add('placed'); correct++;
            d.style.border = '2px solid #22c55e';
        } else {
            d.style.border = '2px solid #ef4444';
        }
    });
    const pts = correct * 10;
    addPoints(pts);
    if(correct === lipidsData.length) unlockAchievement(4);
    alert(`Has clasificado correctamente ${correct} de ${lipidsData.length}. Ganaste ${pts} puntos.`);
}

function resetDragDrop() {
    renderDragDrop();
    document.querySelectorAll('.drop-items').forEach(d => d.innerHTML = '');
}

// L√ìGICA CALCULADORA
function calculateIodine() {
    const v = document.getElementById('calc-fatty-acid').value;
    const res = document.getElementById('calc-result');
    const val = document.getElementById('calc-value');
    if(v === "") { res.style.display='none'; return; }
    res.style.display='block';
    val.textContent = '√çndice de Yodo: ' + v;
    document.getElementById('calc-interpretation').textContent = v==0 ? 'Saturado (S√≥lido)' : (v<100 ? 'Monoinsaturado (L√≠quido)' : 'Poliinsaturado (Muy fluido)');
}

function calculateMeltingPoint() {
    const c = parseInt(document.getElementById('calc-chain-length').value);
    const b = parseInt(document.getElementById('calc-double-bonds').value);
    const cfg = document.getElementById('calc-config').value;
    
    let mp = (c - 10) * 5;
    if(b > 0 && cfg === 'cis') mp -= b * 20;
    else if(b > 0 && cfg === 'trans') mp -= b * 5;
    
    document.getElementById('calc-mp-result').style.display = 'block';
    document.getElementById('calc-mp-value').textContent = `~${mp.toFixed(1)} ¬∞C`;
    document.getElementById('calc-mp-interpretation').textContent = mp > 25 ? 'Estado S√ìLIDO a T¬∞ ambiente' : 'Estado L√çQUIDO a T¬∞ ambiente';
}

// L√ìGICA FLASHCARDS
function renderFlashcards() {
    let html = '';
    flashcardsData.forEach(c => {
        html += `<div class="flashcard" onclick="this.classList.toggle('flipped')">
            <div style="font-size:2rem;margin-bottom:0.5rem">üß¨</div>
            <div class="flashcard-front">${c.front}</div>
            <div class="flashcard-back">${c.back}</div>
        </div>`;
    });
    document.getElementById('flashcard-container').innerHTML = html;
}

// L√ìGICA EJERCICIOS
function renderPreguntas() {
    let h = '<div class="card"><div class="card-header" style="background:#fefce8">3.0 Preliminares</div><div class="question-list">';
    preguntasData.pre.forEach((p, i) => h += crearPregunta(`pre-${i}`, p, i+1));
    h += '</div></div>';
    
    const secs = ['sec31','sec32','sec33','sec34','sec35','sec36','sec37','sec38'];
    const cols = ['#eff6ff','#f0fdf4','#fffbeb','#eef2ff','#faf5ff','#ecfdf5','#fef2f2','#fff7ed'];
    
    secs.forEach((s, idx) => {
        const sec = preguntasData[s];
        h += `<div class="card"><div class="card-header" style="background:${cols[idx]}">${sec.titulo}</div><div class="question-list">`;
        h += `<div style="margin-bottom:1rem;font-weight:700;color:#6b7280;font-size:0.8rem">DESARROLLO</div>`;
        sec.dev.forEach((p, i) => h += crearPregunta(`${s}-d-${i}`, p, i+1));
        h += `<div style="margin:1rem 0;font-weight:700;color:#6b7280;font-size:0.8rem;border-top:1px solid #eee;padding-top:1rem">APLICACI√ìN</div>`;
        sec.app.forEach((p, i) => h += crearPregunta(`${s}-a-${i}`, p, i+1));
        h += `</div></div>`;
    });
    document.getElementById('preguntas-container').innerHTML = h;
}

function crearPregunta(id, txt, num) {
    const val = respuestas[id] || '';
    const comp = val.trim().length > 10 ? 'completed' : '';
    return `<div class="question-item ${comp}" id="box-${id}">
        <span class="question-text">${num}. ${txt}</span>
        <textarea oninput="guardar('${id}',this.value)" placeholder="Escribe tu respuesta...">${val}</textarea>
    </div>`;
}

function guardar(id, val) {
    respuestas[id] = val;
    saveSystem.save(true);
    const el = document.getElementById('box-'+id);
    if(val.trim().length > 10) {
        el.classList.add('completed');
        if(!userStats.achievements[1]) unlockAchievement(1);
    } else {
        el.classList.remove('completed');
    }
    actualizarProgreso();
}

function actualizarProgreso() {
    let total = 0, filled = 0;
    // Total aproximado de preguntas
    total = preguntasData.pre.length + Object.values(preguntasData).reduce((acc, val) => {
        if(val.dev) return acc + val.dev.length + val.app.length;
        return acc;
    }, 0);
    
    for(let k in respuestas) if(respuestas[k].length > 10) filled++;
    
    if(filled >= 10) checkAchievement(2);
    // Logros 7 y 8 simplificados
    if(filled > 20) checkAchievement(7);
    if(filled > 30) checkAchievement(8);
}

function exportar() {
    saveSystem.downloadBackup();
}

// INICIO
document.addEventListener('DOMContentLoaded', init);

</script>
</body>
</html>
